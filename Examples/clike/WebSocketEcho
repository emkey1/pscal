#!/usr/bin/env clike

int main() {
  int s = socketcreate(0);
  if (s < 0) {
    printf("socketcreate failed: %d\n", socketlasterror());
    return 1;
  }

  str host = "echo.websocket.events";
  int port = 80;
  str path = "/";

  if (socketconnect(s, host, port) != 0) {
    int err = socketlasterror();
    if (err == 5) {
      printf("DNS lookup for %s failed (error %d), trying fallback...\n", host, err);
      host = "demos.kaazing.com";
      path = "/echo";
      port = 80;
      if (socketconnect(s, host, port) != 0) {
        printf("socketconnect failed for fallback host: %d\n", socketlasterror());
        socketclose(s);
        return 1;
      }
    } else {
      printf("socketconnect failed: %d\n", err);
      socketclose(s);
      return 1;
    }
  }

  printf("Connected to %s:%d\n", host, port);

  str request = "GET " + path + " HTTP/1.1\r\n";
  request = request + "Host: " + host + "\r\n";
  request = request + "Upgrade: websocket\r\n";
  request = request + "Connection: Upgrade\r\n";
  request = request + "Sec-WebSocket-Version: 13\r\n";
  request = request + "Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==\r\n\r\n";

  if (socketsend(s, request) < 0) {
    printf("failed to send handshake: %d\n", socketlasterror());
    socketclose(s);
    return 1;
  }

  mstream resp = socketreceive(s, 1024);
  if (resp == NULL) {
    printf("handshake receive failed: %d\n", socketlasterror());
    socketclose(s);
    return 1;
  }

  str handshakeResp = mstreambuffer(resp);
  printf("handshake:\n%s\n", handshakeResp);
  mstreamfree(&resp);

  // send masked text frame "hi"
  if (socketsend(s, "\x81\x82\x12\x34\x56\x78\x7a\x5d") < 0) {
    printf("failed to send WebSocket frame: %d\n", socketlasterror());
    socketclose(s);
    return 1;
  }

  mstream msg = socketreceive(s, 1024);
  if (msg == NULL) {
    printf("echo receive failed: %d\n", socketlasterror());
    socketclose(s);
    return 1;
  }

  str buf = mstreambuffer(msg);
  int msglen = strlen(buf);
  if (msglen >= 4) {
    printf("echo: %c%c\n", buf[3], buf[4]);
  } else {
    printf("unexpected echo payload (length=%d)\n", msglen);
  }
  mstreamfree(&msg);
  socketclose(s);
  return 0;
}
