#!/usr/bin/env clike
/*
 * Simple Space style shooter using SDL graphics and sound.
 */

str ConfiguredShotSoundPath = "@PSCAL_INSTALL_ROOT_RESOLVED@/lib/sounds/paddle_hit.wav";
str ConfiguredExplodeSoundPath = "@PSCAL_INSTALL_ROOT_RESOLVED@/lib/sounds/wall_hit.wav";

int main() {
#ifdef SDL_ENABLED
    int ScreenWidth;
    int ScreenHeight;
    int PlayerX;
    int PlayerY;
    int PlayerW;
    int PlayerH;
    int PlayerSpeed;
    int PlayerLives;
    int PlayerInvincibleTicks;
    int PlayerShotCooldown;

    int BulletX;
    int BulletY;
    int BulletW;
    int BulletH;
    int BulletSpeed;
    int BulletActive;

    const int AlienRows = 3;
    const int AlienCols = 6;
    const int AlienCount = AlienRows * AlienCols;
    int AlienW;
    int AlienH;
    int AlienPaddingX;
    int AlienPaddingY;
    int AlienDir;
    int AlienSpeed;
    int AlienBaseSpeed;
    int AliensAlive;
    int AlienDiveChance;
    int AlienFireChance;

    int i;
    int j;
    int minAlienX;
    int maxAlienX;
    int mouseX;
    int mouseY;
    int mouseButtons;
    int mouseInside;
    int ShotSound;
    int ExplodeSound;
    int ManualQuit;
    int Score;

    /* Arrays are 1-based to match the underlying Pascal VM. */
    int AlienX[AlienCount + 1];
    int AlienY[AlienCount + 1];
    int AlienAlive[AlienCount + 1];
    int AlienHomeX[AlienCount + 1];
    int AlienHomeY[AlienCount + 1];
    int AlienDiving[AlienCount + 1];

    const int MaxAlienBullets = 6;
    int AlienBulletX[MaxAlienBullets];
    int AlienBulletY[MaxAlienBullets];
    int AlienBulletActive[MaxAlienBullets];
    int AlienBulletSpeed;

    randomize();
    ScreenWidth = 800;
    ScreenHeight = 600;
    initgraph(ScreenWidth, ScreenHeight, "CLike Space Game");

    initsoundsystem();
    ShotSound = loadsound(ConfiguredShotSoundPath);
    ExplodeSound = loadsound(ConfiguredExplodeSoundPath);

    PlayerW = 40;
    PlayerH = 20;
    PlayerX = ScreenWidth / 2 - PlayerW / 2;
    PlayerY = ScreenHeight - PlayerH - 10;
    PlayerSpeed = 5;
    PlayerLives = 3;
    PlayerInvincibleTicks = 0;
    PlayerShotCooldown = 0;

    BulletW = 4;
    BulletH = 12;
    BulletSpeed = 10;
    BulletActive = 0;

    AlienW = 30;
    AlienH = 20;
    AlienPaddingX = 10;
    AlienPaddingY = 10;
    AlienBaseSpeed = 2;
    AlienSpeed = AlienBaseSpeed;
    AlienDir = 1;
    ManualQuit = 0;
    Score = 0;

    AlienFireChance = 90;
    AlienDiveChance = 320;

    AlienBulletSpeed = 6;
    i = 0;
    while (i < MaxAlienBullets) {
        AlienBulletActive[i] = 0;
        i = i + 1;
    }

    i = 1;
    while (i <= AlienRows) {
        j = 1;
        while (j <= AlienCols) {
            int idx;
            idx = (i - 1) * AlienCols + j;
            AlienHomeX[idx] = 80 + (j - 1) * (AlienW + AlienPaddingX);
            AlienHomeY[idx] = 60 + (i - 1) * (AlienH + AlienPaddingY);
            AlienX[idx] = AlienHomeX[idx];
            AlienY[idx] = AlienHomeY[idx];
            AlienAlive[idx] = 1;
            AlienDiving[idx] = 0;
            j = j + 1;
        }
        i = i + 1;
    }
    AliensAlive = AlienCount;

    while (!quitrequested() && !ManualQuit && AliensAlive > 0 && PlayerLives > 0) {
        graphloop(16);

        int key;
        key = pollkeyany();
        while (key != 0) {
            if (key == 'q' || key == 'Q') {
                ManualQuit = 1;
                break;
            } else if (key == 1073741904) {
                PlayerX = PlayerX - PlayerSpeed;
            } else if (key == 1073741903) {
                PlayerX = PlayerX + PlayerSpeed;
            } else if (key == 32) {
                if (!BulletActive && PlayerShotCooldown == 0) {
                    BulletActive = 1;
                    BulletX = PlayerX + PlayerW / 2 - BulletW / 2;
                    BulletY = PlayerY - BulletH;
                    PlayerShotCooldown = 12;
                    if (ShotSound != -1) {
                        playsound(ShotSound);
                    }
                }
            }
            key = pollkeyany();
        }
        if (ManualQuit) {
            break;
        }

        getmousestate(&mouseX, &mouseY, &mouseButtons, &mouseInside);
        if (mouseInside) {
            PlayerX = mouseX - PlayerW / 2;
            if ((mouseButtons & 1) && !BulletActive && PlayerShotCooldown == 0) {
                BulletActive = 1;
                BulletX = PlayerX + PlayerW / 2 - BulletW / 2;
                BulletY = PlayerY - BulletH;
                PlayerShotCooldown = 12;
                if (ShotSound != -1) {
                    playsound(ShotSound);
                }
            }
        }

        if (PlayerShotCooldown > 0) {
            PlayerShotCooldown = PlayerShotCooldown - 1;
        }

        if (PlayerX < 0) { PlayerX = 0; }
        if (PlayerX > ScreenWidth - PlayerW) { PlayerX = ScreenWidth - PlayerW; }

        if (BulletActive) {
            BulletY = BulletY - BulletSpeed;
            if (BulletY + BulletH < 0) {
                BulletActive = 0;
            }
        }

        minAlienX = ScreenWidth;
        maxAlienX = 0;
        i = 1;
        while (i <= AlienCount) {
            if (AlienAlive[i]) {
                if (AlienHomeX[i] < minAlienX) { minAlienX = AlienHomeX[i]; }
                if (AlienHomeX[i] + AlienW > maxAlienX) { maxAlienX = AlienHomeX[i] + AlienW; }
            }
            i = i + 1;
        }
        if (AlienDir == 1 && maxAlienX >= ScreenWidth - 10) {
            AlienDir = -1;
            i = 1;
            while (i <= AlienCount) {
                if (AlienAlive[i]) {
                    AlienHomeY[i] = AlienHomeY[i] + AlienH;
                    if (!AlienDiving[i]) {
                        AlienY[i] = AlienHomeY[i];
                    }
                }
                i = i + 1;
            }
        } else if (AlienDir == -1 && minAlienX <= 10) {
            AlienDir = 1;
            i = 1;
            while (i <= AlienCount) {
                if (AlienAlive[i]) {
                    AlienHomeY[i] = AlienHomeY[i] + AlienH;
                    if (!AlienDiving[i]) {
                        AlienY[i] = AlienHomeY[i];
                    }
                }
                i = i + 1;
            }
        }

        {
            int delta;
            delta = AlienSpeed * AlienDir;
            i = 1;
            while (i <= AlienCount) {
                if (AlienAlive[i]) {
                    AlienHomeX[i] = AlienHomeX[i] + delta;
                    if (!AlienDiving[i]) {
                        AlienX[i] = AlienX[i] + delta;
                    } else {
                        int targetX;
                        targetX = PlayerX + PlayerW / 2 - AlienW / 2;
                        if (AlienX[i] < targetX) {
                            AlienX[i] = AlienX[i] + 3;
                        } else if (AlienX[i] > targetX) {
                            AlienX[i] = AlienX[i] - 3;
                        }
                        AlienY[i] = AlienY[i] + 4;
                        if (AlienY[i] > ScreenHeight + AlienH) {
                            AlienDiving[i] = 0;
                            AlienX[i] = AlienHomeX[i];
                            AlienY[i] = AlienHomeY[i];
                        }
                    }
                }
                i = i + 1;
            }
        }

        if (BulletActive) {
            i = 1;
            while (i <= AlienCount) {
                if (AlienAlive[i]) {
                    if (BulletX < AlienX[i] + AlienW &&
                        BulletX + BulletW > AlienX[i] &&
                        BulletY < AlienY[i] + AlienH &&
                        BulletY + BulletH > AlienY[i]) {
                        AlienAlive[i] = 0;
                        AlienDiving[i] = 0;
                        BulletActive = 0;
                        AliensAlive = AliensAlive - 1;
                        Score = Score + 50;
                        printf("Score: %d\n", Score);
                        if (ExplodeSound != -1) {
                            playsound(ExplodeSound);
                        }
                        break;
                    }
                }
                i = i + 1;
            }
        }

        if (AliensAlive > 0) {
            AlienSpeed = AlienBaseSpeed + (AlienCount - AliensAlive) / 4;
            if (AlienSpeed > 6) {
                AlienSpeed = 6;
            }
            if (AlienFireChance > 30 && (AlienCount - AliensAlive) > 6) {
                AlienFireChance = 60;
            }
        }

        if (PlayerInvincibleTicks > 0) {
            PlayerInvincibleTicks = PlayerInvincibleTicks - 1;
        }

        if (random(AlienDiveChance) == 0) {
            int choice;
            choice = random(AlienCount) + 1;
            if (AlienAlive[choice] && !AlienDiving[choice]) {
                AlienDiving[choice] = 1;
                AlienX[choice] = AlienHomeX[choice];
                AlienY[choice] = AlienHomeY[choice];
            }
        }

        if (random(AlienFireChance) == 0) {
            int shooter;
            shooter = random(AlienCount) + 1;
            if (AlienAlive[shooter]) {
                int slot;
                slot = 0;
                while (slot < MaxAlienBullets) {
                    if (!AlienBulletActive[slot]) {
                        AlienBulletActive[slot] = 1;
                        AlienBulletX[slot] = AlienX[shooter] + AlienW / 2;
                        AlienBulletY[slot] = AlienY[shooter] + AlienH;
                        break;
                    }
                    slot = slot + 1;
                }
            }
        }

        i = 0;
        while (i < MaxAlienBullets) {
            if (AlienBulletActive[i]) {
                AlienBulletY[i] = AlienBulletY[i] + AlienBulletSpeed;
                if (AlienBulletY[i] > ScreenHeight) {
                    AlienBulletActive[i] = 0;
                } else {
                    if (PlayerInvincibleTicks == 0 &&
                        AlienBulletX[i] >= PlayerX &&
                        AlienBulletX[i] <= PlayerX + PlayerW &&
                        AlienBulletY[i] >= PlayerY &&
                        AlienBulletY[i] <= PlayerY + PlayerH) {
                        AlienBulletActive[i] = 0;
                        PlayerLives = PlayerLives - 1;
                        PlayerInvincibleTicks = 120;
                        BulletActive = 0;
                        printf("Hit! Lives remaining: %d\n", PlayerLives);
                        PlayerX = ScreenWidth / 2 - PlayerW / 2;
                    }
                }
            }
            i = i + 1;
        }

        i = 1;
        while (i <= AlienCount) {
            if (AlienAlive[i]) {
                if (!AlienDiving[i] && AlienY[i] + AlienH >= PlayerY) {
                    PlayerLives = PlayerLives - 1;
                    PlayerInvincibleTicks = 120;
                    printf("Aliens breached the defenses! Lives remaining: %d\n", PlayerLives);
                    break;
                }
            }
            i = i + 1;
        }

        cleardevice();
        if (PlayerInvincibleTicks % 20 < 10 || PlayerInvincibleTicks == 0) {
            setrgbcolor(0, 255, 0);
            fillrect(PlayerX, PlayerY, PlayerX + PlayerW - 1, PlayerY + PlayerH - 1);
        }
        if (BulletActive) {
            setrgbcolor(255, 255, 0);
            fillrect(BulletX, BulletY, BulletX + BulletW - 1, BulletY + BulletH - 1);
        }
        setrgbcolor(255, 0, 0);
        i = 1;
        while (i <= AlienCount) {
            if (AlienAlive[i]) {
                fillrect(AlienX[i], AlienY[i], AlienX[i] + AlienW - 1, AlienY[i] + AlienH - 1);
            }
            i = i + 1;
        }
        setrgbcolor(255, 255, 255);
        i = 0;
        while (i < MaxAlienBullets) {
            if (AlienBulletActive[i]) {
                drawline(AlienBulletX[i], AlienBulletY[i], AlienBulletX[i], AlienBulletY[i] + 6);
            }
            i = i + 1;
        }

        updatescreen();
    }

    quitsoundsystem();
    closegraph();
    if (AliensAlive == 0) {
        printf("You saved the galaxy! Final score: %d\n", Score);
    } else if (PlayerLives <= 0) {
        printf("Game over. Final score: %d\n", Score);
    }
    return 0;
#else
    printf("SDL support not enabled.\n");
    return 1;
#endif
}
