#!/usr/bin/env rea
// SDL Solar System Simulation in Rea using OOP and threads.
// Each planet runs in its own thread and the frame rate is throttled.

const int NumPlanets = 9;

bool quit = false;
int posMutex = mutex();

class Planet {
  int orbit;
  int size;

  float speed; // degrees per update

  int r;
  int g;
  int b;
  float angle;
  float posX;
  float posY;
  int centerX;
  int centerY;
  int tid;

    Planet init(int o, int s, float spd, int red, int green, int blue, int cx, int cy) {
      myself.orbit = o;
      myself.size = s;
      myself.speed = spd;
      myself.r = red;
      myself.g = green;
      myself.b = blue;
      myself.centerX = cx;
      myself.centerY = cy;
      myself.angle = random(360);
      float rad = myself.angle * 0.017453292519943295;
      myself.posX = cx + cos(rad) * o;
      myself.posY = cy + sin(rad) * o;
      return myself;
    }

    void updateWorker() {
      while (!quit) {
        myself.angle = myself.angle + (myself.speed / 10.0);
        if (myself.angle >= 360.0) myself.angle = myself.angle - 360.0;
        float rad = myself.angle * 0.017453292519943295;
        float px = myself.centerX + cos(rad) * myself.orbit;
        float py = myself.centerY + sin(rad) * myself.orbit;
        lock(posMutex);
        myself.posX = px;
        myself.posY = py;
        unlock(posMutex);
        delay(16);
      }
    }

    void start() {
      myself.tid = spawn Planet_updateWorker(myself);
    }

    // Wait for the worker thread to finish. "join" is a reserved keyword in
    // Rea, so give the method a more explicit name to avoid confusion with the
    // built-in thread operation.
    void joinThread() {
      join myself.tid;
    }

  }

void Planet_draw(Planet p) {
  setrgbcolor(p.r, p.g, p.b);
  fillcircle(trunc(p.posX), trunc(p.posY), p.size);
}

class SolarSystemApp {
  const int WindowWidth = 800;
  const int WindowHeight = 600;
  const int TargetFPS = 60;

    int FrameDelay;
    int centerX;
    int centerY;
    Planet planets[NumPlanets + 1];

  void SolarSystemApp() {
    // no special initialization needed beyond defaults
  }

  void initPlanets() {
    myself.planets[1] = new Planet(); Planet_init(myself.planets[1], 40, 3, 4.7, 200, 200, 200, myself.centerX, myself.centerY);  // Mercury
    myself.planets[2] = new Planet(); Planet_init(myself.planets[2], 60, 4, 3.5, 255, 165,   0, myself.centerX, myself.centerY);  // Venus
    myself.planets[3] = new Planet(); Planet_init(myself.planets[3], 80, 5, 3.0,   0,   0, 255, myself.centerX, myself.centerY);  // Earth
    myself.planets[4] = new Planet(); Planet_init(myself.planets[4],100, 3, 2.4, 255,   0,   0, myself.centerX, myself.centerY);  // Mars
    myself.planets[5] = new Planet(); Planet_init(myself.planets[5],160,16, 1.3, 210, 105,  30, myself.centerX, myself.centerY);  // Jupiter
    myself.planets[6] = new Planet(); Planet_init(myself.planets[6],200,15, 0.9, 210, 180, 140, myself.centerX, myself.centerY);  // Saturn
    myself.planets[7] = new Planet(); Planet_init(myself.planets[7],240, 9, 0.7, 135, 206, 235, myself.centerX, myself.centerY);  // Uranus
    myself.planets[8] = new Planet(); Planet_init(myself.planets[8],270, 9, 0.5,  65, 105, 225, myself.centerX, myself.centerY);  // Neptune
    myself.planets[9] = new Planet(); Planet_init(myself.planets[9],290, 2, 0.4, 169, 169, 169, myself.centerX, myself.centerY);  // Pluto
  }

  void startThreads() {
    int i = 1;
    while (i <= NumPlanets) {
      Planet_start(myself.planets[i]);
      i = i + 1;
    }
  }

  void draw() {
    lock(posMutex);
    cleardevice();
    setrgbcolor(255, 255, 0); // Sun
    fillcircle(myself.centerX, myself.centerY, 12);
    int i = 1;
    while (i <= NumPlanets) {
      Planet_draw(myself.planets[i]);
      i = i + 1;
    }
    unlock(posMutex);
    updatescreen();
  }

  void joinThreads() {
    int i = 1;
    while (i <= NumPlanets) {
      Planet_joinThread(myself.planets[i]);
      i = i + 1;
    }
  }

  void run() {
    initgraph(WindowWidth, WindowHeight, "Rea SDL Solar System");
    myself.centerX = getmaxx() / 2;
    myself.centerY = getmaxy() / 2;
    randomize();
    myself.FrameDelay = trunc(1000 / TargetFPS);
    myself.initPlanets();
    // Start planet worker threads using the current object instance
    myself.startThreads();
    writeln("Solar system simulation running. Press Q to quit.");
    while (!quit) {
      if (keypressed()) {
        char c = readkey();
        if (toupper(c) == 'Q') quit = true;
      }
      // Draw all planets based on their updated positions
      myself.draw();
      // Use the object's frame delay to pace the main loop and yield time to
      // planet worker threads, ensuring smooth motion.
      graphloop(myself.FrameDelay);
    }
    // Wait for all planet worker threads to finish before shutting down
    myself.joinThreads();
    closegraph();
    writeln("Simulation finished.");
  }
}

SolarSystemApp app = new SolarSystemApp();
SolarSystemApp_run(app);

