#!/usr/bin/env pascal
program SDLFireworksDemo;

const
  MAX_PARTICLES = 400;
  GRAV = 0.15;
  PI = 3.14159;

type
  Particle = record
    x, y   : Real;
    vx, vy : Real;
    life   : Integer;
    r, g, b: Integer;
  end;

var
  Particles: array[0..MAX_PARTICLES-1] of Particle;
  i, mx, my, buttons: Integer;
  fontsize: Integer;
  boom: Integer;
  FontFileName : String;

procedure SpawnFirework(px, py: Integer);
var j: Integer; angle, speed: Real;
begin
  for j := 0 to MAX_PARTICLES-1 do
  begin
    angle := (Random(360)) * PI / 180.0;
    speed := Random(300) / 100.0;
    Particles[j].x := px;
    Particles[j].y := py;
    Particles[j].vx := cos(angle) * speed;
    Particles[j].vy := sin(angle) * speed;
    Particles[j].life := 100 + Random(80);
    Particles[j].r := Random(255);
    Particles[j].g := Random(255);
    Particles[j].b := Random(255);
  end;
  if boom <> -1 then
    PlaySound(boom);   { play once when spawning }
end;

begin
  InitGraph(800, 600, 'Fireworks!');
  InitSoundSystem();
  boom := LoadSound('explosion.wav');
  FontFileName := '/usr/local/Pscal/fonts/Roboto/static/Roboto-Regular.ttf'; // The default font
  FontSize := 24;
  InitTextSystem(FontFileName, FontSize);

  SpawnFirework(400, 300);  { initial burst }

  while PollKey() <> Ord('q') do
  begin
    ClearDevice();

    GetMouseState(mx, my, buttons);
    if (buttons and 1) <> 0 then
      SpawnFirework(mx, my);

    for i := 0 to MAX_PARTICLES-1 do
      if Particles[i].life > 0 then
      begin
        Particles[i].x := Particles[i].x + Particles[i].vx;
        Particles[i].y := Particles[i].y + Particles[i].vy;
        Particles[i].vy := Particles[i].vy + GRAV;
        Particles[i].life := Particles[i].life - 1;
        SetAlphaBlend(true);
        SetRGBColor(Particles[i].r, Particles[i].g, Particles[i].b);
        FillCircle(Round(Particles[i].x), Round(Particles[i].y), 2);
      end;

    OutTextXY(10, 10, 'Click to launch fireworks – Q quits');
    UpdateScreen();
    GraphLoop(16);  { ~60 fps }
  end;

  if boom <> -1 then FreeSound(boom);
  QuitSoundSystem();
  QuitTextSystem();
  CloseGraph();
end.

