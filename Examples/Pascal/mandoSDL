#!/usr/bin/env pascal
PROGRAM SDLMandelbrotWithStatus;

// USES System; // Implicit for Sqrt, Trunc, WriteLn etc. if not global

CONST
  WindowWidth   = 1024;
  WindowHeight  = 768;
  WindowTitle   = 'Mandelbrot Set (SDL)';
//  MaxIterations = 255;
  MaxIterations = 128;
  StatusUpdateInterval = 20; // Print status every 20 rows
  ScreenUpdateInterval = 1;  // Refresh SDL window every row
  MandelBytesPerPixel = 4;

TYPE
  PixelBuffer = ARRAY[0..(WindowWidth * WindowHeight * MandelBytesPerPixel) - 1] OF Byte;

VAR
  Px, Py        : Integer; // Pixel coordinates
  x0, y0        : Real;    // Coordinates in the complex plane
  x, y          : Real;    // Current z value
  xTemp         : Real;
  Iteration     : Integer;
  R, G, B       : Byte;

  MinRe         : Real;
  MaxRe         : Real;
  MinIm         : Real;
  MaxIm         : Real;

  ReRange, ImRange : Real;
  ScaleRe, ScaleIm : Real;
  CurrentMaxX, CurrentMaxY : Integer;
  ViewPixelWidth, ViewPixelHeight : Integer;

  MandelTextureID : Integer;
  PixelData : PixelBuffer;
  BufferBaseIdx : Integer;

  PercentDone : Integer;

BEGIN
  MinRe := -2.0;
  MaxRe := 1.0;
  MinIM := -1.2;

  // Initial message to the terminal
  WriteLn('Calculating Mandelbrot set for a ', WindowWidth, 'x', WindowHeight, ' window.');
  WriteLn('The graphics window will update as the calculation progresses.');
  WriteLn;
  WriteLn('Progress updates will be shown here in the terminal.');
  WriteLn('-----------------------------------------------------');
  // You could add a Delay(1000) here if you want users to definitely see the message

  InitGraph(WindowWidth, WindowHeight, WindowTitle);
  MandelTextureID := CreateTexture(WindowWidth, WindowHeight);
  IF MandelTextureID < 0 THEN
  BEGIN
    WriteLn('Error: unable to create texture.');
    Halt;
  END;
  ClearDevice;  UpdateScreen;  // show blank window immediately

  CurrentMaxX := GetMaxX;
  CurrentMaxY := GetMaxY;
  ViewPixelWidth  := CurrentMaxX + 1;
  ViewPixelHeight := CurrentMaxY + 1;

  ReRange := MaxRe - MinRe;
  MaxIm := MinIm + (ReRange * ViewPixelHeight) / ViewPixelWidth;
  ImRange := MaxIm - MinIm;

  IF ViewPixelWidth > 1 THEN ScaleRe := ReRange / (ViewPixelWidth - 1)
  ELSE IF ViewPixelWidth = 1 THEN ScaleRe := ReRange ELSE ScaleRe := 0;
  IF ViewPixelHeight > 1 THEN ScaleIm := ImRange / (ViewPixelHeight - 1)
  ELSE IF ViewPixelHeight = 1 THEN ScaleIm := ImRange ELSE ScaleIm := 0;

  // Initialize progress tracking
  PercentDone := 0;

  // Main loop through each pixel, updating texture progressively
  FOR Py := 0 TO ViewPixelHeight - 1 DO
  BEGIN
    y0 := MaxIm - (Py * ScaleIm);
    FOR Px := 0 TO ViewPixelWidth - 1 DO
    BEGIN
      x0 := MinRe + (Px * ScaleRe);

      x := 0.0;
      y := 0.0;
      Iteration := 0;

      WHILE (x*x + y*y <= 4.0) AND (Iteration < MaxIterations) DO
      BEGIN
        xTemp := x*x - y*y + x0;
        y     := 2*x*y + y0;
        x     := xTemp;
        Iteration := Iteration + 1;
      END;

      IF Iteration = MaxIterations THEN
      BEGIN
        R := 0; G := 0; B := 0;
      END
      ELSE
      BEGIN
        R := (Iteration * 5) MOD 256;
        G := (Iteration * 7 + 85) MOD 256;
        B := (Iteration * 11 + 170) MOD 256;
      END;

      BufferBaseIdx := (Py * ViewPixelWidth + Px) * MandelBytesPerPixel;
      PixelData[BufferBaseIdx + 0] := R;
      PixelData[BufferBaseIdx + 1] := G;
      PixelData[BufferBaseIdx + 2] := B;
      PixelData[BufferBaseIdx + 3] := 255;
    END; // END FOR Px

    // Status Update Logic
    // Py is 0-indexed, CurrentMaxY is max index. (CurrentMaxY + 1) is total rows.
    IF (Py + 1) MOD StatusUpdateInterval = 0 THEN // After every 'StatusUpdateInterval' rows
    BEGIN
        PercentDone := Trunc( (Py + 1) * 100.0 / (CurrentMaxY + 1) );
        WriteLn('Processing row ', Py + 1, ' of ', CurrentMaxY + 1, '. Approximately ', PercentDone, '% complete...');
    END
    ELSE IF Py = CurrentMaxY THEN // Ensure a 100% message on the last row if not caught by interval
    BEGIN
        WriteLn('Processing row ', Py + 1, ' of ', CurrentMaxY + 1, '. Approximately 100% complete...');
    END;

    // Periodic texture and screen update so the window displays while calculating
    IF ((Py + 1) MOD ScreenUpdateInterval = 0) OR (Py = ViewPixelHeight - 1) THEN
    BEGIN
      UpdateTexture(MandelTextureID, PixelData);
      ClearDevice;
      RenderCopy(MandelTextureID);
      UpdateScreen;
      GraphLoop(0);
    END;

  END; // END FOR Py

  WriteLn('-----------------------------------------------------');
  WriteLn('Calculation complete! Displaying Mandelbrot set.');

  UpdateTexture(MandelTextureID, PixelData);
  ClearDevice;
  RenderCopy(MandelTextureID);
  UpdateScreen;

  GraphLoop(100);
  ReadKey;

  DestroyTexture(MandelTextureID);
  CloseGraph;
END.
