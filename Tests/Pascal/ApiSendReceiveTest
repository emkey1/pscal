program apiSendReceiveTest;

var
  ms: mstream;
  response: string;
  url: string;
  cwd: string;
begin
  cwd := getenv('PWD');
  { Determine the correct path to the data file whether the test is
    executed from the Tests directory or the Pascal subdirectory }
  { The data file is named "ApiSendReceiveTest.data" (note the capital A).
    Support running either from the Tests directory or its Pascal subdirectory. }
  if fileexists(cwd + '/ApiSendReceiveTest.data') then
    url := 'file://' + cwd + '/ApiSendReceiveTest.data'
  else
    url := 'file://' + cwd + '/Pascal/ApiSendReceiveTest.data';
  ms := apiSend(url, '');
  response := apiReceive(ms);
  if pos('Example Domain', response) = 0 then
  begin
    writeln('Unexpected API response');
    halt(1);
  end;
  writeln('API send/receive test passed');
end.
