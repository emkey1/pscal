#!/usr/bin/env pascal
PROGRAM SDLFeaturesTest;

USES CRT; // For console WriteLn and ReadKey

CONST
  ScreenWidth  = 1024;
  ScreenHeight = 768;
  Title        = 'Pascal SDL Features Test';
  SystemFontPath  = '/usr/local/Pscal/fonts/Roboto/static/Roboto-Regular.ttf';
  RepoFontPath    = 'fonts/Roboto/static/Roboto-Regular.ttf';
  FontSize        = 18;

  // Mouse button constants (example mapping)
  ButtonLeft   = 1;
  ButtonMiddle = 2;
  ButtonRight  = 4;

VAR
  mx, my, buttons : Integer;
  insideWindow    : Integer;
  lastButtons     : Integer;
  lastInside      : Integer;
  quit            : Boolean;
  eventInfo       : String;
  frameCount      : Integer;
  r, g, b         : Byte;

FUNCTION ShouldQuit: Boolean;
VAR
  keyCode: Integer;
BEGIN
  ShouldQuit := False;

  keyCode := PollKeyAny();
  IF keyCode <> 0 THEN
  BEGIN
    IF (keyCode >= 0) AND (keyCode <= $FF) THEN
    BEGIN
      IF Chr(keyCode) IN ['q', 'Q'] THEN
      BEGIN
        ShouldQuit := True;
        EXIT;
      END;
    END;
  END;

  IF QuitRequested THEN
  BEGIN
    ShouldQuit := True;
    EXIT;
  END;
END;

BEGIN
  InitGraph(ScreenWidth, ScreenHeight, Title);
  if FileExists(SystemFontPath) then
    InitTextSystem(SystemFontPath, FontSize)
  else
    InitTextSystem(RepoFontPath, FontSize); // Initialize font system

  quit := False;
  frameCount := 0;
  eventInfo := 'Move mouse and click... Press Q to quit.';
  lastButtons := -1;
  lastInside := -1;

  // Main loop
  WHILE NOT quit DO
  BEGIN
    frameCount := frameCount + 1;

    // Get mouse state (capture inside flag for debugging feedback)
    GetMouseState(mx, my, buttons, insideWindow);

    if (buttons <> lastButtons) or (insideWindow <> lastInside) then
    begin
      WriteLn('[Mouse] x=', mx, ' y=', my, ' buttons=', buttons, ' inside=', insideWindow);
      lastButtons := buttons;
      lastInside := insideWindow;
    end;

    // --- Background ---
    SetRGBColor(30, 30, 50); // Dark blue background
    FillRect(0, 0, GetMaxX, GetMaxY);

    // --- Draw a Line that follows the mouse Y ---
    SetRGBColor(100, 200, 255); // Light blue
    DrawLine(0, my, GetMaxX, my);

    // --- Draw a Rectangle that follows the mouse X ---
    SetRGBColor(255, 100, 100); // Light red
    FillRect(mx - 20, 50, mx + 20, 100); // A small rectangle

    // --- Draw a Circle that changes radius with mouse X ---
    // Ensure MOD results are always positive and in range 0..255
    r := ((frameCount DIV 2) MOD 256 + 256) MOD 256;
    g := ((100 + frameCount DIV 3) MOD 256 + 256) MOD 256;
    b := ((200 - frameCount DIV 4) MOD 256 + 256) MOD 256; // <<<< CORRECTED LINE
    SetRGBColor(r,g,b);
    DrawCircle(GetMaxX DIV 2, GetMaxY DIV 2, (mx MOD 100) + 20);

    // --- Text Output ---
    SetRGBColor(255, 255, 0); // Yellow text
    OutTextXY(10, 10, 'Pascal SDL Test Program!');
    OutTextXY(10, 30, 'Mouse X: ' + IntToStr(mx) + ' Y: ' + IntToStr(my));
    OutTextXY(10, 50, 'Buttons: ' + IntToStr(buttons) + ' Inside: ' + IntToStr(insideWindow));
    OutTextXY(10, ScreenHeight - 30, eventInfo);

    // --- Handle Mouse Clicks for simple interaction ---
    IF (buttons AND ButtonLeft) <> 0 THEN
    BEGIN
      SetRGBColor(0, 255, 0); // Green
      FillRect(mx - 5, my - 5, mx + 5, my + 5);
      eventInfo := 'Left Button Clicked!';
    END
    ELSE IF (buttons AND ButtonRight) <> 0 THEN
    BEGIN
      SetRGBColor(255, 0, 0); // Red
      DrawCircle(mx, my, 15);
      eventInfo := 'Right Button Clicked!';
    END
    ELSE IF (buttons AND ButtonMiddle) <> 0 THEN
    BEGIN
       eventInfo := 'Middle Button Clicked!';
    END;

    UpdateScreen;
    GraphLoop(16);

    quit := ShouldQuit;

  END; // WHILE NOT quit

  QuitTextSystem;
  CloseGraph;

  WriteLn('Test program finished.');
END.
