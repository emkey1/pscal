#!/usr/bin/env python3
import os, signal, sys, time, tempfile, subprocess
from pathlib import Path

ROOT = Path(__file__).resolve().parents[1]
CLIKE = ROOT / 'build' / 'bin' / 'clike'
SERVER_SRC = ROOT / 'Examples' / 'clike' / 'simple_web_server'
PORT = '5577'

htdocs = Path(tempfile.mkdtemp(prefix='sws_'))
# Prepare a file with a space in the name
(htdocs / 'file name.txt').write_text('hello-file', encoding='utf-8')

srv = None

def cleanup(signum=None, frame=None):
    global srv
    try:
        if srv and srv.poll() is None:
            srv.terminate()
            try:
                srv.wait(2)
            except Exception:
                srv.kill()
    finally:
        # best effort cleanup of temp dir
        pass
    sys.exit(0)

signal.signal(signal.SIGTERM, cleanup)
signal.signal(signal.SIGINT, cleanup)

srv = subprocess.Popen([str(CLIKE), str(SERVER_SRC), PORT, str(htdocs)], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)

# Give server time to start
time.sleep(1.0)

try:
    while True:
        time.sleep(5)
except KeyboardInterrupt:
    cleanup()

