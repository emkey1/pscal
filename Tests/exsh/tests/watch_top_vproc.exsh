set -e

# Regression: when running `watch -n ... top` the vproc-backed `top` output
# should include distinct synthetic tasks for both `watch ...` and the spawned
# `top` command.
#
# The harness treats exit code 77 as a skip.

if [ "${RUN_VPROC_TESTS:-0}" != "1" ]; then
    exit 77
fi

set -m

tmp_base="./.exsh-watchtop-$$"
tmp_out="${tmp_base}.out"

rm -f "$tmp_out"

# Run `watch` in the background (separate vproc job thread), then take a
# snapshot with `top` from the shell. This avoids relying on stdout capture
# from the background worker path.
watch -n 0.10 sleep 5 &
wp=$!

sleep 0.20

top >"$tmp_out"

set +e
kill "$wp" >/dev/null 2>&1
set -e

sleep 0.10

found_watch=0
found_sleep=0

while read line; do
    case "$line" in
        (*"watch -n "*sleep\ 5*) found_watch=1 ;;
    esac

    case "$line" in
        ([0-9]*"sleep 5"*)
            case "$line" in
                (*"watch -n "*)
                    ;;
                (*)
                    found_sleep=1
                    ;;
            esac
            ;;
    esac
done < "$tmp_out"

if [ "$found_watch" -ne 1 ]; then
    echo "FAIL: missing watch task label in top output" >&2
    exit 1
fi
if [ "$found_sleep" -ne 1 ]; then
    echo "FAIL: missing spawned sleep task in top output" >&2
    exit 1
fi

rm -f "$tmp_out"
