set -e

# Regression: when running `watch -n ... top` in the foreground, the watched
# command should still run in its own synthetic vproc and the shell should not
# get its CMD label overwritten.
#
# The harness treats exit code 77 as a skip.

if [ "${RUN_VPROC_TESTS:-0}" != "1" ]; then
    exit 77
fi

tmp_base="./.exsh-watchtop-fg-$$"
tmp_out="${tmp_base}.out"

rm -f "$tmp_out"

watch -n 0.10 -c 1 top >"$tmp_out"

found_watch=0
found_top=0
found_shell=0

while read line; do
    case "$line" in
        (*"watch -n "*top*) found_watch=1 ;;
    esac
    case "$line" in
        (*" shell"*) found_shell=1 ;;
    esac
    case "$line" in
        (*"watch -n "*) ;;
        (*" top"*) found_top=1 ;;
    esac
done < "$tmp_out"

if [ "$found_watch" -ne 1 ]; then
    echo "FAIL: missing watch task label in watched top output" >&2
    exit 1
fi
if [ "$found_top" -ne 1 ]; then
    echo "FAIL: missing top task label in watched top output" >&2
    exit 1
fi
if [ "$found_shell" -ne 1 ]; then
    echo "FAIL: missing shell task label in watched top output" >&2
    exit 1
fi

rm -f "$tmp_out"
