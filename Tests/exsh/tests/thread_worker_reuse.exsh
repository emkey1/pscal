#!/usr/bin/env exsh
set -euo pipefail

iterations=18
ids=""
wait_statuses=""
status_requeries=""

iteration=1
while [ "$iteration" -le "$iterations" ]; do
    tid=$(builtin ThreadSpawnBuiltin str:delay int:10)
    WaitForThread "$tid"
    wait_statuses="$wait_statuses $EXSH_LAST_STATUS"
    if requery=$(builtin ThreadGetStatus "$tid" bool:true 2>/dev/null); then
        status_requeries="$status_requeries $requery"
    else
        status_requeries="$status_requeries error"
    fi
    ids="$ids $tid"
    iteration=$((iteration + 1))
done

trim() {
    printf '%s' "$1" | awk '{$1=$1;print}'
}

wait_trim=$(trim "$wait_statuses")
requery_trim=$(trim "$status_requeries")

unique_ids=""
unique_count=0
for id in $(trim "$ids"); do
    case " $unique_ids " in
        *" $id "*) ;;
        *) unique_ids="$unique_ids $id"; unique_count=$((unique_count + 1));;
    esac
done

unique_ids=$(trim "$unique_ids")

echo "iterations:$iterations"
echo "unique:$unique_count"
echo "unique_ids:$unique_ids"
echo "wait_statuses:$wait_trim"
echo "status_requeries:$requery_trim"
