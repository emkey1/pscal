#!/usr/bin/env exsh
set -euo pipefail

iterations=18
ids=""
wait_statuses=""
status_reads=""

iteration=1
while [ "$iteration" -le "$iterations" ]; do
    tid=$(builtin ThreadSpawnBuiltin str:delay int:10)
    WaitForThread "$tid"
    wait_statuses="$wait_statuses $EXSH_LAST_STATUS"
    status_reads="$status_reads $(builtin ThreadGetStatus "$tid" bool:true)"
    ids="$ids $tid"
    iteration=$((iteration + 1))
done

trim() {
    printf '%s' "$1" | awk '{$1=$1;print}'
}

wait_trim=$(trim "$wait_statuses")
reads_trim=$(trim "$status_reads")

unique_ids=""
unique_count=0
for id in $(trim "$ids"); do
    case " $unique_ids " in
        *" $id "*) ;;
        *) unique_ids="$unique_ids $id"; unique_count=$((unique_count + 1));;
    esac
done

unique_ids=$(trim "$unique_ids")

echo "iterations:$iterations"
echo "unique:$unique_count"
echo "unique_ids:$unique_ids"
echo "wait_statuses:$wait_trim"
echo "status_reads:$reads_trim"
