#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TMP_FALLBACK="$SCRIPT_DIR/tmp"

ensure_tmpdir() {
    local candidate="${TMPDIR:-}"
    local probe=""
    if [ -n "$candidate" ]; then
        if probe="$(TMPDIR="$candidate" mktemp -d 2>/dev/null)"; then
            rmdir "$probe"
            export TMPDIR="$candidate"
            return
        fi
    fi

    mkdir -p "$TMP_FALLBACK"
    if probe="$(TMPDIR="$TMP_FALLBACK" mktemp -d 2>/dev/null)"; then
        rmdir "$probe"
        export TMPDIR="$TMP_FALLBACK"
        return
    fi

    echo "Unable to create a writable temporary directory. Set TMPDIR manually and retry." >&2
    exit 1
}

ensure_tmpdir

pushd "$SCRIPT_DIR" >/dev/null
trap 'popd >/dev/null' EXIT

# Network tests are disabled by default. Set RUN_NET_TESTS=1 to enable.
export RUN_NET_TESTS="${RUN_NET_TESTS:-0}"

echo "Running Pascal Tests"
bash ./run_pascal_tests.sh
echo "Pascal Tests End"
echo
echo "====================================="
echo "Running CLike Tests"
bash ./run_clike_tests.sh
echo "CLike Tests End"
echo
echo "====================================="
echo "Running exsh Tests"
bash ./run_exsh_tests.sh
echo "exsh Tests End"
echo
echo "====================================="
echo "Running Rea Tests"
bash ./run_rea_tests.sh
echo "Rea Tests End"
echo
echo "====================================="
echo "Running Tiny Tests"
bash ./run_tiny_tests.sh
echo
echo "Tiny Tests End"
echo
echo "====================================="
echo "Running Example Program Tests"
python3 ./examples/run_examples.py
echo "Example Program Tests End"
echo
echo "Running JSON2BC Tests"
bash ./run_json2bc_tests.sh
echo "JSON2BC Tests End"
